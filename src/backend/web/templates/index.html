{% extends "base.html" %}

{% load static %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è ‚Äî Knowledge Vault{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
<div class="welcome-header">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Knowledge Vault!</h1>
</div>

{% if user.is_authenticated %}
    {% if just_logged_in %}
        <p class="welcome-message">üéâ –í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ, {{ user.username }}.</p>
    {% endif %}

    <div class="grid">
        <!-- TODO Block -->
        <div class="card">
            <div class="card-header">
                <h2>üìã TODO</h2>
                <button id="add-task-btn" class="btn primary">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                <button class="filter-btn" data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="filter-btn" data-filter="tomorrow">–ó–∞–≤—Ç—Ä–∞</button>
                <button class="filter-btn" data-filter="week">–ù–µ–¥–µ–ª—è</button>
                <button class="filter-btn" data-filter="month">–ú–µ—Å—è—Ü</button>
            </div>
            <ul id="task-list-container" class="task-list">
                {% for task in tasks %}
                    {% if not task.parent %}
                        <li class="task-item" data-task-id="{{ task.id }}" data-end-time="{{ task.end_time|date:'c' }}">
                            <div class="task-header">
                                {% if task.subtasks.all %}
                                    <button class="btn-icon toggle-subtasks-btn">‚ñ∂</button>
                                {% endif %}
                                <div class="task-info">
                                    <div class="task-name">{{ task.name }}</div>
                                    <div class="task-meta">
                                        {% if task.end_time %}
                                            ‚è∞ –¥–æ {{ task.end_time|date:"d.m.Y H:i" }}
                                        {% endif %}
                                    </div>
                                    {% if task.tags.all %}
                                        <div class="task-tags">
                                            {% for tag in task.tags.all %}
                                                <span class="tag">{{ tag.name }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="task-actions">
                                    <button class="btn-icon add-subtask-btn" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É">+</button>
                                </div>
                            </div>
                            <ul class="subtask-list" style="display: none;"></ul>
                        </li>
                    {% endif %}
                {% empty %}
                    <div class="empty-state">
                        <p>–ù–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>
                    </div>
                {% endfor %}
            </ul>
        </div>

        <!-- Documents Block -->
        <div class="card">
            <div class="card-header">
                <h2>üìÅ –î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
                <label for="document-upload-input" class="btn primary" style="cursor: pointer;">+ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>
                <input type="file" id="document-upload-input" style="display: none;" multiple>
            </div>
            <ul id="doc-list-container" class="doc-list">
                {% for doc in documents %}
                    <li class="doc-item">
                        <div class="doc-info">
                            <div class="doc-name">üìÑ {{ doc.name }}</div>
                            <div class="doc-meta">
                                .{{ doc.extension }} ‚Ä¢ {{ doc.uploaded_at|date:"d.m.Y"  }}
                            </div>
                        </div>
                    </li>
                {% empty %}
                    <div class="empty-state">
                        <p>–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π!</p>
                    </div>
                {% endfor %}
            </ul>
        </div>
    </div>
{% else %}
    <div class="guest-message">
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Knowledge Vault –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.</p>
        <div class="guest-actions">
            <a class="btn" href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
            <a class="btn primary" href="{% url 'register' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
    </div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div id="add-task-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content auth-card">
        <button class="modal-close-btn">&times;</button>
        <h2>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
        <form id="add-task-form" method="post" action="{% url 'add_task' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name" required id="id_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
                <div class="field-error"></div>
            </div>
            <div class="form-group">
                <label for="id_description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" rows="4" id="id_description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
                <div class="field-error"></div>
            </div>
            <div class="form-group">
                <label for="id_end_time">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="datetime-local" name="end_time" class="form-control" id="id_end_time">
                <div class="field-error"></div>
            </div>
            <div class="form-group">
                <label for="id_tags">–¢–µ–≥–∏</label>
                <select name="tags" id="id_tags" multiple class="form-control">
                    <option value="" disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏...</option>
                    {% for tag in user.tags.all %}
                        <option value="{{ tag.pk }}">{{ tag.name }}</option>
                    {% endfor %}
                </select>
                <div class="field-error"></div>
            </div>
            <input type="hidden" name="parent_id" id="parent_id_input">
            <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
    </div>
</div>
{% endblock %}